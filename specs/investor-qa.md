# Investor Q&A Specification

**Topic of Concern**: AI-powered Q&A chat for investors — streaming chat interface where investors ask questions about company data, powered by RAG over document embeddings + financial data + profile metadata

**One-Sentence Description**: The system provides a streaming chat interface where investors ask natural-language questions about a company, with responses generated by Claude via RAG over document embeddings, financial data, and profile metadata, delivered token-by-token via Server-Sent Events (SSE).

---

## Overview

The Investor Q&A is a conversational AI feature embedded in the company profile experience. Investors with FULL access (via the `InvestorAccess` model) or email-gated profile viewers can ask questions about the company, and the system generates accurate, sourced answers by:

1. Embedding the question using the same model as document chunks (from `ai-document-intelligence.md`)
2. Retrieving relevant context via pgvector cosine similarity search across the company's `DocumentChunk` records
3. Augmenting context with profile metadata (about, metrics, team) and financial highlights (from Open Finance, if available)
4. Streaming Claude's response token-by-token via SSE

Each conversation is scoped to a single company profile. The founder (ADMIN) can view all conversations for their company but cannot respond — the AI answers exclusively.

### Relationship to Existing Features

- **[ai-document-intelligence.md](./ai-document-intelligence.md)**: Provides the `DocumentChunk` embeddings that power RAG retrieval. Q&A depends on documents being processed and chunked.
- **[company-profile.md](./company-profile.md)**: Q&A is accessed through the company profile. Profile metadata (headline, description, sector, metrics, team) is included as context for answer generation.
- **[company-dataroom.md](./company-dataroom.md)**: Dataroom documents are the primary source material. Source citations link back to dataroom documents.
- **[open-finance.md](./open-finance.md)**: Financial highlights from Open Finance connections are included as supplementary context when available.
- **[notifications.md](./notifications.md)**: A `QA_QUESTION_RECEIVED` notification is sent to the founder when an investor asks a question.
- **[user-permissions.md](./user-permissions.md)**: Only ADMIN role can view all conversations. Investor access is controlled via `InvestorAccess` model.

---

## MVP Scope

### In Scope (MVP)

| Feature | Notes |
|---------|-------|
| **Streaming chat interface** | Token-by-token SSE delivery of AI responses |
| **RAG over document embeddings** | pgvector cosine similarity search across company's DocumentChunks |
| **Source citations** | Each answer includes references to source documents with excerpts |
| **Conversation history** | Persistent conversations with message history |
| **Profile metadata context** | Company description, metrics, team info included in RAG context |
| **Rate limiting** | Per-investor daily message limits and per-conversation token budgets |
| **Founder conversation viewer** | Read-only view of all investor Q&A conversations |
| **Email-gated viewer support** | Non-registered investors with valid email can use Q&A |
| **Auto-generated titles** | Conversation title generated from first question |

### Out of Scope (Post-MVP)

| Feature | Reason |
|---------|--------|
| **Founder replies** | Founder does not chat — AI answers exclusively. Human-in-the-loop deferred to post-MVP |
| **Suggested questions** | Pre-populated question suggestions based on available documents deferred |
| **Multi-language system prompt** | System prompt is in the language of the question; explicit language preference deferred |
| **Conversation sharing** | Investors cannot share conversations with other investors |
| **Conversation export** | PDF/CSV export of conversation history deferred |
| **Real-time typing indicators** | No "investor is typing" indicator for founder viewer |
| **Push notifications for new questions** | Only in-app notification; real-time push deferred |

---

## User Stories

### US-1: Ask a Question About the Company
**As an** investor with FULL access to a company profile
**I want to** ask natural-language questions about the company's financials, team, and documents
**So that** I can quickly understand key aspects of the company without manually reading every document

### US-2: View Source Citations
**As an** investor reading an AI-generated answer
**I want to** see which documents the answer is based on, with clickable links
**So that** I can verify the information and read the full source material

### US-3: Continue a Conversation
**As an** investor returning to the company profile
**I want to** see my previous conversations and continue asking follow-up questions
**So that** I don't lose context from prior research

### US-4: View Investor Conversations (Founder)
**As a** company admin
**I want to** see all Q&A conversations from all investors
**So that** I can understand what investors are asking about and identify areas of interest or concern

### US-5: Ask Questions as Email-Gated Viewer
**As a** non-registered investor viewing an email-gated profile
**I want to** use the Q&A chat after providing my email
**So that** I can get answers about the company without creating a Navia account

---

## Functional Requirements

### FR-1: Conversation Management
- System MUST create a new conversation when an investor sends their first message
- Conversation title MUST be auto-generated from the first question (first 80 characters, or AI-summarized if longer)
- Each conversation is scoped to a single company profile
- Maximum 50 messages per conversation (user + assistant combined)
- Maximum 5 active conversations per investor per company

### FR-2: RAG Pipeline
- System MUST embed the investor's question using the same embedding model as document chunks
- System MUST perform pgvector cosine similarity search across the company's `DocumentChunk` records, retrieving the top 10 most relevant chunks
- System MUST assemble context from: relevant chunks + profile metadata (headline, description, sector, metrics, team) + financial highlights (if available from Open Finance)
- System MUST use the following system prompt template:

```
You are an AI assistant for {companyName}. Answer questions based only on the provided context. If the information isn't in the context, say so clearly — do not make up information. Always cite which documents your answer is based on using [Source: document name] format. Respond in the same language as the question.
```

- System MUST stream Claude's response via SSE (token by token)
- After stream completion, system MUST store the full message, source chunk IDs, and token count

### FR-3: Access Control
- Only investors with FULL access level (from `InvestorAccess` model) can use Q&A
- Email-gated profile viewers with a valid, verified email can use Q&A
- Founder/ADMIN can view all conversations for their company (read-only)
- Each investor can only access their own conversations
- Conversations are not accessible across companies

### FR-4: Rate Limiting
- 20 messages per investor per day per company
- 10,000 token budget per conversation (combined context + response tokens)
- Maximum 50 messages per conversation
- Maximum 5 concurrent conversations per investor per company

### FR-5: Notifications and Audit
- System MUST send a `QA_QUESTION_RECEIVED` notification to the company founder when an investor asks a question
- System MUST create an audit log entry for each Q&A interaction
- System MUST log token usage for cost tracking

---

## Data Models

### QAConversation Entity

```typescript
interface QAConversation {
  id: string;                          // UUID, primary key
  profileId: string;                   // Foreign key to CompanyProfile
  userId: string | null;               // Foreign key to User (null for email-gated viewers)
  viewerEmail: string | null;          // Email for non-registered investors
  title: string | null;                // Auto-generated from first question
  messageCount: number;                // Denormalized count for limit enforcement
  totalTokensUsed: number;             // Cumulative tokens across all messages
  createdAt: Date;
  updatedAt: Date;
}
```

### QAMessage Entity

```typescript
interface QAMessage {
  id: string;                          // UUID, primary key
  conversationId: string;              // Foreign key to QAConversation
  role: QARole;                        // USER | ASSISTANT | SYSTEM
  content: string;                     // Message text
  tokensUsed: number;                  // Tokens consumed by this message (input + output for ASSISTANT)
  sourceChunkIds: string[];            // DocumentChunk IDs that informed the answer
  createdAt: Date;
}

enum QARole {
  USER = 'USER',
  ASSISTANT = 'ASSISTANT',
  SYSTEM = 'SYSTEM',
}
```

### Prisma Schema

```prisma
model QAConversation {
  id              String      @id @default(uuid())
  profileId       String      @map("profile_id")
  userId          String?     @map("user_id")
  viewerEmail     String?     @map("viewer_email")
  title           String?
  messageCount    Int         @default(0) @map("message_count")
  totalTokensUsed Int         @default(0) @map("total_tokens_used")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  profile  CompanyProfile @relation(fields: [profileId], references: [id])
  user     User?          @relation(fields: [userId], references: [id])
  messages QAMessage[]

  @@index([profileId, createdAt])
  @@index([userId])
  @@index([viewerEmail, profileId])
  @@map("qa_conversations")
}

model QAMessage {
  id              String    @id @default(uuid())
  conversationId  String    @map("conversation_id")
  role            QARole
  content         String    @db.Text
  tokensUsed      Int       @default(0) @map("tokens_used")
  sourceChunkIds  String[]  @map("source_chunk_ids")
  createdAt       DateTime  @default(now()) @map("created_at")

  conversation QAConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("qa_messages")
}

enum QARole {
  USER
  ASSISTANT
  SYSTEM

  @@map("qa_role")
}
```

---

## API Endpoints

### Start Conversation

#### POST /api/v1/companies/:companyId/profile/qa/conversations

**Description**: Create a new Q&A conversation and send the first message. Returns the conversation metadata and initiates SSE streaming for the AI response.

**Auth**: Required. Investor with FULL access level, or email-gated viewer with valid email.

**Request**:
```json
{
  "message": "What is the company's monthly revenue?"
}
```

**Response** (201 Created):
```json
{
  "success": true,
  "data": {
    "id": "conv_001",
    "profileId": "profile_001",
    "title": "What is the company's monthly revenue?",
    "messageCount": 1,
    "totalTokensUsed": 0,
    "streamUrl": "/api/v1/companies/:companyId/profile/qa/conversations/conv_001/messages/msg_001/stream",
    "createdAt": "2026-02-26T14:30:00.000Z"
  }
}
```

**Error Responses**:
- `403 Forbidden` — Investor does not have FULL access (`QA_ACCESS_DENIED`)
- `422 Unprocessable Entity` — Company has no processed documents (`QA_NO_DOCUMENTS`)
- `422 Unprocessable Entity` — Concurrent conversation limit reached (`QA_CONVERSATION_LIMIT`)

---

### Send Message (SSE Streaming)

#### POST /api/v1/companies/:companyId/profile/qa/conversations/:conversationId/messages

**Description**: Send a message in an existing conversation and receive the AI response as an SSE stream.

**Auth**: Required. Must be the conversation owner (same user or same viewer email).

**Request**:
```json
{
  "message": "Can you elaborate on the expenses?"
}
```

**Response**: `200 OK` with `Content-Type: text/event-stream`

**SSE Event Types**:

```
event: token
data: {"token": "The"}

event: token
data: {"token": " company"}

event: token
data: {"token": "'s"}

event: source
data: {"chunkId": "chunk_001", "documentName": "Balance Sheet Q3.pdf", "excerpt": "Total expenses for Q3 2025 reached R$ 450.000,00..."}

event: source
data: {"chunkId": "chunk_042", "documentName": "Financial Projections.xlsx", "excerpt": "Operating expenses breakdown shows..."}

event: done
data: {"messageId": "msg_002", "tokensUsed": 450}

event: error
data: {"code": "QA_RATE_LIMITED", "messageKey": "errors.qa.rateLimited"}
```

**Error Responses**:
- `403 Forbidden` — Not the conversation owner (`QA_ACCESS_DENIED`)
- `404 Not Found` — Conversation not found (`QA_CONVERSATION_NOT_FOUND`)
- `422 Unprocessable Entity` — Conversation message limit reached (`QA_CONVERSATION_LIMIT`)
- `422 Unprocessable Entity` — Token budget exceeded (`QA_CONTEXT_TOO_LARGE`)
- `429 Too Many Requests` — Daily message limit exceeded (`QA_RATE_LIMITED`)
- `502 Bad Gateway` — Claude API unavailable (`QA_SERVICE_UNAVAILABLE`)

---

### Get Conversation History

#### GET /api/v1/companies/:companyId/profile/qa/conversations/:conversationId

**Description**: Retrieve a conversation with all its messages and source citations.

**Auth**: Required. Conversation owner or company ADMIN.

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "id": "conv_001",
    "profileId": "profile_001",
    "userId": "user_001",
    "viewerEmail": null,
    "title": "What is the company's monthly revenue?",
    "messageCount": 4,
    "totalTokensUsed": 1250,
    "createdAt": "2026-02-26T14:30:00.000Z",
    "updatedAt": "2026-02-26T14:35:00.000Z",
    "messages": [
      {
        "id": "msg_001",
        "role": "USER",
        "content": "What is the company's monthly revenue?",
        "tokensUsed": 0,
        "sourceChunkIds": [],
        "createdAt": "2026-02-26T14:30:00.000Z"
      },
      {
        "id": "msg_002",
        "role": "ASSISTANT",
        "content": "Based on the financial documents available, the company's monthly recurring revenue (MRR) is R$ 120.000,00 as of Q3 2025. [Source: Balance Sheet Q3.pdf] ...",
        "tokensUsed": 350,
        "sourceChunkIds": ["chunk_001", "chunk_042"],
        "sources": [
          {
            "chunkId": "chunk_001",
            "documentId": "doc_001",
            "documentName": "Balance Sheet Q3.pdf",
            "excerpt": "Total MRR reached R$ 120.000,00 in September 2025..."
          }
        ],
        "createdAt": "2026-02-26T14:30:05.000Z"
      }
    ]
  }
}
```

---

### List Conversations (Founder)

#### GET /api/v1/companies/:companyId/profile/qa/conversations

**Description**: List all Q&A conversations for the company profile. Paginated.

**Auth**: Required. ADMIN role.

**Query Parameters**:

| Parameter | Type | Description |
|-----------|------|-------------|
| `page` | integer | Page number (default: 1) |
| `limit` | integer | Items per page (default: 20, max: 100) |
| `investorId` | UUID | Filter by investor user ID |
| `investorEmail` | string | Filter by viewer email |
| `dateFrom` | ISO 8601 | Conversations created after this date |
| `dateTo` | ISO 8601 | Conversations created before this date |
| `sort` | string | Sort field (default: `-createdAt`) |

**Response** (200 OK):
```json
{
  "success": true,
  "data": [
    {
      "id": "conv_001",
      "profileId": "profile_001",
      "userId": "user_001",
      "viewerEmail": null,
      "investorName": "Carlos Ferreira",
      "investorEmail": "c***@fund.com",
      "title": "What is the company's monthly revenue?",
      "messageCount": 4,
      "totalTokensUsed": 1250,
      "lastMessageAt": "2026-02-26T14:35:00.000Z",
      "createdAt": "2026-02-26T14:30:00.000Z"
    }
  ],
  "meta": {
    "total": 15,
    "page": 1,
    "limit": 20,
    "totalPages": 1
  }
}
```

---

### List Investor's Own Conversations

#### GET /api/v1/companies/:companyId/profile/qa/my-conversations

**Description**: List the current investor's conversations for a company profile. Paginated.

**Auth**: Required. Investor with FULL access level, or email-gated viewer.

**Query Parameters**:

| Parameter | Type | Description |
|-----------|------|-------------|
| `page` | integer | Page number (default: 1) |
| `limit` | integer | Items per page (default: 20, max: 100) |

**Response** (200 OK):
```json
{
  "success": true,
  "data": [
    {
      "id": "conv_001",
      "title": "What is the company's monthly revenue?",
      "messageCount": 4,
      "lastMessageAt": "2026-02-26T14:35:00.000Z",
      "createdAt": "2026-02-26T14:30:00.000Z"
    }
  ],
  "meta": {
    "total": 2,
    "page": 1,
    "limit": 20,
    "totalPages": 1
  }
}
```

---

### Delete Conversation

#### DELETE /api/v1/companies/:companyId/profile/qa/conversations/:conversationId

**Description**: Delete a Q&A conversation and all its messages.

**Auth**: Required. ADMIN role only.

**Response**: `204 No Content`

---

## Business Rules

### BR-1: Access Control
- Only investors with `InvestorAccess.accessLevel = 'FULL'` for the company can use Q&A
- Email-gated profile viewers who have provided a valid email can use Q&A (viewerEmail is stored on the conversation)
- If an investor's access level is downgraded from FULL, they cannot send new messages but can still view their existing conversations

### BR-2: Rate Limiting
- 20 messages per investor per day per company (resets at 00:00 UTC)
- 10,000 token budget per conversation (combined input context + output response tokens across all messages)
- Maximum 50 messages per conversation (USER + ASSISTANT combined)
- Maximum 5 active conversations per investor per company (a conversation is "active" if it has fewer than 50 messages)
- When a limit is reached, the system returns the appropriate error code and the investor must wait or start reviewing existing conversations

### BR-3: Context Assembly
- RAG context is assembled in this priority order:
  1. Top 10 relevant document chunks (pgvector cosine similarity, threshold >= 0.7)
  2. Profile metadata: headline, description, sector, location, founded year
  3. Profile metrics: all published metric labels and values
  4. Profile team: names and titles of team members
  5. Financial highlights from Open Finance (if connected): latest revenue, expenses, cash position
- Total context is capped at 8,000 tokens. If assembled context exceeds this, lower-ranked chunks are dropped.
- Previous conversation messages (up to last 10 messages) are included for conversational continuity

### BR-4: Source Citations
- Every ASSISTANT message must include source chunk IDs linking to the DocumentChunks that informed the answer
- Source citations include: chunk ID, parent document ID, document name, and a relevant excerpt (first 200 characters of the chunk)
- If the AI cannot find relevant information in the context, it must say so explicitly and return an empty source list

### BR-5: Conversation Lifecycle
- Conversations are created on the first message
- Title is auto-generated: first 80 characters of the first question, trimmed at the nearest word boundary
- Conversations with no messages for 30 days are considered stale (displayed with a "stale" indicator in the UI, but not auto-deleted)
- Only ADMIN can delete conversations

---

## RAG Pipeline

### Flow

```
Investor sends question
    |
    v
Embed question (same model as DocumentChunks)
    |
    v
pgvector cosine similarity search
(scoped to company's DocumentChunks, top 10, threshold >= 0.7)
    |
    v
Assemble context:
  - Relevant document chunks (with metadata)
  - Profile metadata (headline, description, sector, metrics, team)
  - Financial highlights (Open Finance, if available)
  - Last 10 conversation messages (for continuity)
    |
    v
Build prompt:
  - System prompt (company name, rules, language instruction)
  - Context block (numbered sources)
  - Conversation history
  - Current question
    |
    v
Stream Claude response via SSE (token by token)
    |
    v
On stream completion:
  - Store full ASSISTANT message
  - Record source chunk IDs
  - Record token usage
  - Update conversation counters (messageCount, totalTokensUsed)
  - Send QA_QUESTION_RECEIVED notification to founder
  - Create audit log entry (QA_QUESTION_ASKED)
```

### System Prompt Template

```
You are an AI assistant for {companyName}. Your role is to help investors understand the company by answering their questions accurately and concisely.

Rules:
1. Answer questions based ONLY on the provided context. Do not use any outside knowledge.
2. If the information needed to answer the question is not in the context, say so clearly. Do not guess or make up information.
3. Always cite your sources using the format [Source: document name]. Include the source at the end of the relevant sentence or paragraph.
4. If multiple sources support an answer, cite all of them.
5. Use Brazilian number formatting (1.234,56) for all numbers and currency values.
6. Respond in the same language as the question.
7. Be concise but thorough. Prefer bullet points for lists.
8. For financial data, always specify the time period (e.g., "Q3 2025", "January 2026").

Context:
{assembledContext}
```

### Context Block Format

```
=== DOCUMENT SOURCES ===

[1] Document: "Balance Sheet Q3.pdf" (chunk 3 of 12)
{chunk content}

[2] Document: "Financial Projections.xlsx" (chunk 1 of 5)
{chunk content}

...

=== COMPANY PROFILE ===

Company: {companyName}
Headline: {headline}
Sector: {sector}
Founded: {foundedYear}
Location: {location}
Description: {description}

Metrics:
- {metric1Label}: {metric1Value}
- {metric2Label}: {metric2Value}

Team:
- {member1Name}, {member1Title}
- {member2Name}, {member2Title}

=== FINANCIAL HIGHLIGHTS ===
(Only if Open Finance data is available)

Monthly Revenue: R$ {mrr}
Monthly Expenses: R$ {expenses}
Cash Position: R$ {cash}
Period: {snapshotDate}
```

---

## Error Codes

### QA Error Codes

| Code | messageKey | HTTP | PT-BR | EN |
|------|-----------|------|-------|-----|
| `QA_RATE_LIMITED` | `errors.qa.rateLimited` | 429 | Limite de mensagens diarias atingido. Tente novamente amanha. | Daily message limit reached. Try again tomorrow. |
| `QA_ACCESS_DENIED` | `errors.qa.accessDenied` | 403 | Voce nao tem acesso ao Q&A desta empresa. | You don't have access to this company's Q&A. |
| `QA_NO_DOCUMENTS` | `errors.qa.noDocuments` | 422 | Esta empresa ainda nao possui documentos processados para consulta. | This company doesn't have processed documents available for queries. |
| `QA_CONTEXT_TOO_LARGE` | `errors.qa.contextTooLarge` | 422 | O orcamento de tokens desta conversa foi excedido. Inicie uma nova conversa. | This conversation's token budget has been exceeded. Start a new conversation. |
| `QA_CONVERSATION_NOT_FOUND` | `errors.qa.conversationNotFound` | 404 | Conversa nao encontrada. | Conversation not found. |
| `QA_CONVERSATION_LIMIT` | `errors.qa.conversationLimit` | 422 | Limite de mensagens desta conversa atingido. Inicie uma nova conversa. | This conversation's message limit has been reached. Start a new conversation. |
| `QA_CONCURRENT_LIMIT` | `errors.qa.concurrentLimit` | 422 | Limite de conversas ativas atingido. Conclua uma conversa antes de iniciar outra. | Active conversation limit reached. Finish a conversation before starting a new one. |
| `QA_SERVICE_UNAVAILABLE` | `errors.qa.serviceUnavailable` | 502 | O servico de IA esta temporariamente indisponivel. Tente novamente em alguns minutos. | AI service is temporarily unavailable. Please try again in a few minutes. |
| `QA_EMPTY_MESSAGE` | `errors.qa.emptyMessage` | 400 | A mensagem nao pode estar vazia. | Message cannot be empty. |
| `QA_MESSAGE_TOO_LONG` | `errors.qa.messageTooLong` | 400 | A mensagem excede o limite de 2.000 caracteres. | Message exceeds the 2,000 character limit. |

### Audit Events

| Action | Resource Type | Actor Type | When Triggered |
|--------|-------------|-----------|---------------|
| `QA_CONVERSATION_CREATED` | QAConversation | USER | New conversation started |
| `QA_QUESTION_ASKED` | QAMessage | USER | Investor sends a question |
| `QA_ANSWER_GENERATED` | QAMessage | SYSTEM | AI generates a response |
| `QA_CONVERSATION_DELETED` | QAConversation | USER | Admin deletes a conversation |

### Notification Events

| Notification Type | Recipient | When Triggered |
|------------------|-----------|---------------|
| `QA_QUESTION_RECEIVED` | Company ADMIN(s) | Investor asks a question (debounced: max 1 notification per investor per 15 minutes) |

---

## Frontend Specification

### Page Routing

| Route | Component | Description |
|-------|-----------|-------------|
| `/p/:slug` (Q&A tab or section) | `InvestorQAChat` | Chat interface within the public profile page |
| `/companies/:companyId/profile/qa` | `FounderQAViewer` | Founder's view of all investor conversations |

### Investor Chat Interface

```
+-------------------------------------------------------------+
|  [<- Back to Profile]          Q&A with {CompanyName}        |
+-------------------------------------------------------------+
|  +-------------------+  +----------------------------------+ |
|  | Conversations     |  |                                  | |
|  |                   |  |  [Assistant avatar]               | |
|  | > Monthly revenue |  |  Based on the financial documents | |
|  |   Feb 26, 2026    |  |  available, the company's MRR is  | |
|  |                   |  |  R$ 120.000,00 as of Q3 2025.    | |
|  |   Team background |  |  [Source: Balance Sheet Q3.pdf]  | |
|  |   Feb 25, 2026    |  |                                  | |
|  |                   |  |                [User avatar]     | |
|  |                   |  |  Can you elaborate on expenses?   | |
|  |                   |  |                                  | |
|  |                   |  |  [Assistant avatar]               | |
|  |                   |  |  The main expense categories...   | |
|  |                   |  |  |  (streaming tokens appear)     | |
|  |                   |  |                                  | |
|  | [+ New Chat]      |  +----------------------------------+ |
|  +-------------------+  | Type your question...    [Send]  | |
+-------------------------------------------------------------+
```

**Layout details**:
- Left sidebar: conversation list (240px width, collapsible on mobile)
- Main area: chat message thread with input at bottom
- Messages use a bubble layout: user messages right-aligned with `blue-600` background, assistant messages left-aligned with `gray-50` background
- Source citations appear below assistant messages as clickable chips/badges
- On mobile: conversation list becomes a slide-over panel

### Chat Message Bubbles

**User message**:
- Alignment: right
- Background: `blue-600`
- Text color: white
- Border radius: `radius-lg` with squared bottom-right corner
- Max width: 75% of chat area
- Timestamp: `caption` (12px), below the bubble, `gray-500`

**Assistant message**:
- Alignment: left
- Background: `gray-50`
- Text color: `gray-700`
- Border radius: `radius-lg` with squared bottom-left corner
- Max width: 75% of chat area
- Supports markdown rendering (bold, lists, code blocks)
- Timestamp: `caption` (12px), below the bubble, `gray-500`

**Source citations** (below assistant messages):
- Displayed as a horizontal row of pill badges
- Badge: `blue-50` background, `blue-600` text, `radius-full`, `caption` size
- Icon: `FileText` Lucide icon (12px) before document name
- On click: opens the document in the dataroom (scrolls to it or opens download)
- On hover: tooltip with the excerpt text (first 200 characters)

### Streaming Display

- While waiting for the first token: show a "Thinking..." indicator (three animated dots) in a gray assistant bubble
- Tokens appear one by one in the assistant bubble, creating a typewriter effect
- The chat area auto-scrolls to keep the latest content visible during streaming
- The send button is disabled while a response is streaming
- Source citations appear after the `event: done` SSE event (not during streaming)

### Conversation List Sidebar

- Lists all conversations for the current investor, ordered by `updatedAt` descending
- Each item shows: title (truncated to 1 line), last message date
- Active conversation is highlighted with `blue-50` background and `blue-600` left border (3px)
- "New Chat" button at bottom: primary variant, full width
- Empty state: "No conversations yet. Ask your first question!" with illustration

### Founder Conversation Viewer

```
+-------------------------------------------------------------+
|  h1: Investor Q&A                                            |
|  body-sm: Veja as perguntas que investidores fizeram          |
+-------------------------------------------------------------+
|  Filters: [Investor v] [Date Range] [Search...]              |
+-------------------------------------------------------------+
|  +----------------------------------------------------------+|
|  | Carlos Ferreira (c***@fund.com)           4 messages      ||
|  | "What is the company's monthly revenue?"  26/02/2026      ||
|  +----------------------------------------------------------+|
|  | Maria Santos (m***@vc.com)                2 messages      ||
|  | "Tell me about the founding team"         25/02/2026      ||
|  +----------------------------------------------------------+|
|                                                               |
|  Showing 1-10 of 15                    < 1 2 >               |
+-------------------------------------------------------------+
```

**Layout details**:
- Standard page header pattern (design-system.md Section 5.5)
- Filter bar with: investor name/email search, date range picker
- Conversation list as table rows, clickable to expand into read-only chat view
- Each row shows: investor name (masked email), conversation title, message count, last activity date
- Click on a row navigates to a read-only view of the full conversation
- No reply capability — the viewer is strictly read-only

### Component List

| Component | File Path | Description |
|-----------|-----------|-------------|
| `InvestorQAChat` | `frontend/src/components/qa/InvestorQAChat.tsx` | Main chat interface for investors with conversation sidebar and message thread |
| `QAChatThread` | `frontend/src/components/qa/QAChatThread.tsx` | Message thread with streaming display, auto-scroll, and source citations |
| `QAMessageBubble` | `frontend/src/components/qa/QAMessageBubble.tsx` | Individual message bubble (user or assistant) with timestamp |
| `QASourceCitation` | `frontend/src/components/qa/QASourceCitation.tsx` | Clickable source citation badge with tooltip excerpt |
| `QAConversationList` | `frontend/src/components/qa/QAConversationList.tsx` | Sidebar listing investor's conversations with selection state |
| `QAChatInput` | `frontend/src/components/qa/QAChatInput.tsx` | Message input field with send button, character count, and disabled state during streaming |
| `QAThinkingIndicator` | `frontend/src/components/qa/QAThinkingIndicator.tsx` | Animated "Thinking..." dots shown while waiting for first token |
| `QAStreamingText` | `frontend/src/components/qa/QAStreamingText.tsx` | Component that renders tokens as they arrive via SSE |
| `FounderQAViewer` | `frontend/src/components/qa/FounderQAViewer.tsx` | Founder's read-only view with conversation list, filters, and detail view |
| `FounderQAConversationList` | `frontend/src/components/qa/FounderQAConversationList.tsx` | Paginated table of all investor conversations with filters |
| `FounderQAConversationDetail` | `frontend/src/components/qa/FounderQAConversationDetail.tsx` | Read-only view of a single conversation's messages |
| `QAEmptyState` | `frontend/src/components/qa/QAEmptyState.tsx` | Empty state for no conversations or no messages |

### TanStack Query Hooks

```typescript
// frontend/src/hooks/use-qa.ts

/**
 * useQAConversations(companyId: string)
 * Fetches the current investor's conversations for a company.
 * GET /api/v1/companies/:companyId/profile/qa/my-conversations
 * Returns: QAConversation[]
 * Query key: ['qa-conversations', companyId]
 * Refetch: on window focus
 */

/**
 * useQAConversation(companyId: string, conversationId: string)
 * Fetches a single conversation with all messages.
 * GET /api/v1/companies/:companyId/profile/qa/conversations/:conversationId
 * Returns: QAConversation with messages[]
 * Query key: ['qa-conversation', companyId, conversationId]
 * Refetch: after sending a message (mutation onSuccess)
 */

/**
 * useCreateQAConversation(companyId: string)
 * Mutation: POST /api/v1/companies/:companyId/profile/qa/conversations
 * Body: { message: string }
 * onSuccess: invalidate ['qa-conversations', companyId], navigate to new conversation
 * Returns: { conversationId, streamUrl }
 */

/**
 * useSendQAMessage(companyId: string, conversationId: string)
 * Mutation: POST /api/v1/companies/:companyId/profile/qa/conversations/:conversationId/messages
 * Body: { message: string }
 * Does NOT use standard TanStack Query mutation — uses EventSource/fetch for SSE streaming.
 * On stream completion: invalidate ['qa-conversation', companyId, conversationId]
 */

/**
 * useFounderQAConversations(companyId: string, params?)
 * Fetches all conversations for the founder view.
 * GET /api/v1/companies/:companyId/profile/qa/conversations
 * Returns: PaginatedApiResponse<QAConversation>
 * Query key: ['founder-qa-conversations', companyId, params]
 */

/**
 * useDeleteQAConversation(companyId: string)
 * Mutation: DELETE /api/v1/companies/:companyId/profile/qa/conversations/:conversationId
 * onSuccess: invalidate ['founder-qa-conversations', companyId], show success toast
 */
```

### SSE Streaming Hook

```typescript
// frontend/src/hooks/use-sse-stream.ts

/**
 * useSSEStream(url: string)
 *
 * Custom hook that manages an SSE connection for streaming AI responses.
 * Uses the native EventSource API or fetch with ReadableStream.
 *
 * State:
 * - tokens: string[] — accumulated tokens
 * - sources: QASource[] — source citations (received after streaming)
 * - isStreaming: boolean — whether tokens are currently being received
 * - isThinking: boolean — waiting for the first token
 * - error: ApiError | null — error from the stream
 * - messageId: string | null — set when stream completes
 *
 * Methods:
 * - start(body: { message: string }) — initiates the SSE connection
 * - abort() — cancels the current stream
 *
 * Events handled:
 * - 'token' — append token to accumulated text
 * - 'source' — add source citation to sources array
 * - 'done' — set messageId, mark streaming complete
 * - 'error' — set error state, close connection
 */
```

### Loading States

- **Initial page load**: Skeleton layout matching conversation list (3 skeleton items) and chat area (3 skeleton message bubbles)
- **Waiting for first token**: "Thinking..." indicator with animated dots in an assistant bubble
- **Streaming in progress**: Tokens appear in real-time; send button disabled with spinner
- **Sending message**: Input field disabled, send button shows spinner
- **Loading conversation history**: Skeleton message bubbles in the chat area

### Error States

| Error | Display | Recovery |
|-------|---------|----------|
| No documents processed | Centered message in chat area: "Esta empresa ainda nao possui documentos processados" | N/A — investor must wait for founder to upload documents |
| Rate limited (daily) | Toast + inline message: "Limite diario atingido. Tente novamente amanha." | Wait for daily reset at 00:00 UTC |
| Conversation limit (messages) | Inline message at input: "Limite de mensagens atingido. Inicie uma nova conversa." | Start new conversation |
| Token budget exceeded | Inline message at input: "Orcamento de tokens excedido. Inicie uma nova conversa." | Start new conversation |
| AI service unavailable | Toast + retry button in chat: "Servico de IA indisponivel. Tente novamente." | Click retry button |
| Network error during stream | Toast: "Conexao perdida. Tente enviar novamente." | Retry sending the message |
| Access denied | Redirect to profile with toast: "Voce nao tem acesso ao Q&A." | Request access from founder |

### Empty States

**No conversations (investor)**:
- Centered in chat area
- Icon: `MessageCircle` Lucide icon (64px, `gray-300`)
- Title: "Faca sua primeira pergunta" (`h3`, `gray-700`)
- Description: "Pergunte sobre a empresa e receba respostas baseadas nos documentos disponveis." (`body`, `gray-500`, max-width 400px)
- Input field is ready for first message

**No conversations (founder)**:
- Centered in the conversation list area
- Icon: `MessageSquare` Lucide icon (64px, `gray-300`)
- Title: "Nenhuma pergunta recebida" (`h3`, `gray-700`)
- Description: "Quando investidores fizerem perguntas sobre sua empresa, elas aparecero aqui." (`body`, `gray-500`, max-width 400px)

### Frontend i18n Keys

All user-facing strings must be added to both `messages/pt-BR.json` and `messages/en.json`.

**PT-BR translations**:

| Key | PT-BR Value |
|-----|-------------|
| `qa.title` | Perguntas e Respostas |
| `qa.subtitle` | Veja as perguntas que investidores fizeram |
| `qa.placeholder` | Digite sua pergunta... |
| `qa.send` | Enviar |
| `qa.thinking` | Pensando... |
| `qa.sources` | Fontes |
| `qa.sourceLabel` | Fonte: {name} |
| `qa.newChat` | Nova Conversa |
| `qa.conversations` | Conversas |
| `qa.noDocuments` | Esta empresa ainda nao possui documentos processados para consulta. |
| `qa.rateLimited` | Limite de mensagens diarias atingido. Tente novamente amanha. |
| `qa.conversationLimit` | Limite de mensagens desta conversa atingido. Inicie uma nova conversa. |
| `qa.tokenBudgetExceeded` | Orcamento de tokens excedido. Inicie uma nova conversa. |
| `qa.serviceUnavailable` | Servico de IA temporariamente indisponivel. Tente novamente em alguns minutos. |
| `qa.networkError` | Conexao perdida. Tente enviar novamente. |
| `qa.empty.investor.title` | Faca sua primeira pergunta |
| `qa.empty.investor.message` | Pergunte sobre a empresa e receba respostas baseadas nos documentos disponiveis. |
| `qa.empty.founder.title` | Nenhuma pergunta recebida |
| `qa.empty.founder.message` | Quando investidores fizerem perguntas sobre sua empresa, elas aparecero aqui. |
| `qa.conversation.messages` | {count} mensagens |
| `qa.conversation.message` | 1 mensagem |
| `qa.conversation.delete` | Excluir conversa |
| `qa.conversation.deleteConfirm` | Tem certeza que deseja excluir esta conversa? Esta acao nao pode ser desfeita. |
| `qa.conversation.deleteSuccess` | Conversa excluida com sucesso |
| `qa.filter.investor` | Investidor |
| `qa.filter.dateRange` | Periodo |
| `qa.filter.search` | Buscar... |
| `qa.charCount` | {count}/2.000 |
| `qa.messageTooLong` | A mensagem excede o limite de 2.000 caracteres. |

**EN translations**:

| Key | EN Value |
|-----|----------|
| `qa.title` | Questions & Answers |
| `qa.subtitle` | See questions investors have asked |
| `qa.placeholder` | Type your question... |
| `qa.send` | Send |
| `qa.thinking` | Thinking... |
| `qa.sources` | Sources |
| `qa.sourceLabel` | Source: {name} |
| `qa.newChat` | New Chat |
| `qa.conversations` | Conversations |
| `qa.noDocuments` | This company doesn't have processed documents available for queries. |
| `qa.rateLimited` | Daily message limit reached. Try again tomorrow. |
| `qa.conversationLimit` | This conversation's message limit has been reached. Start a new conversation. |
| `qa.tokenBudgetExceeded` | Token budget exceeded. Start a new conversation. |
| `qa.serviceUnavailable` | AI service is temporarily unavailable. Please try again in a few minutes. |
| `qa.networkError` | Connection lost. Try sending again. |
| `qa.empty.investor.title` | Ask your first question |
| `qa.empty.investor.message` | Ask about the company and receive answers based on available documents. |
| `qa.empty.founder.title` | No questions received |
| `qa.empty.founder.message` | When investors ask questions about your company, they'll appear here. |
| `qa.conversation.messages` | {count} messages |
| `qa.conversation.message` | 1 message |
| `qa.conversation.delete` | Delete conversation |
| `qa.conversation.deleteConfirm` | Are you sure you want to delete this conversation? This action cannot be undone. |
| `qa.conversation.deleteSuccess` | Conversation deleted successfully |
| `qa.filter.investor` | Investor |
| `qa.filter.dateRange` | Date Range |
| `qa.filter.search` | Search... |
| `qa.charCount` | {count}/2,000 |
| `qa.messageTooLong` | Message exceeds the 2,000 character limit. |

### Accessibility Requirements

- Chat thread uses `role="log"` with `aria-live="polite"` for screen reader announcements of new messages
- Streaming text updates use `aria-live="polite"` (not `assertive`) to avoid interrupting screen reader users
- Message input has `aria-label="Type your question"` and supports `Enter` to send, `Shift+Enter` for newline
- Source citation badges have `aria-label="Source: {documentName}"` and are keyboard-focusable
- Conversation list items are keyboard navigable with arrow keys
- "Thinking..." indicator has `aria-label="Generating response"` and `role="status"`
- Chat area auto-scroll can be paused by scrolling up manually; a "Scroll to bottom" button appears
- All interactive elements meet the minimum 44x44px tap target on mobile

---

## Edge Cases & Error Handling

### EC-1: No Documents Processed
**Scenario**: Investor tries to use Q&A on a company with no processed documents.
**Handling**: Return `QA_NO_DOCUMENTS` (422). Frontend shows the empty state with explanation. Q&A input is disabled.

### EC-2: Stream Interruption
**Scenario**: Network disconnects mid-stream.
**Handling**: Frontend detects SSE connection close without `done` event. Partial message is displayed with a "Connection lost" indicator and a "Retry" button. On retry, the same question is re-sent (a new ASSISTANT message is created, not resuming the old stream).

### EC-3: Claude API Rate Limited
**Scenario**: Anthropic API returns 429.
**Handling**: Backend catches the error and sends an `event: error` with `QA_SERVICE_UNAVAILABLE`. Frontend shows retry option with exponential backoff suggestion.

### EC-4: Concurrent Requests
**Scenario**: Investor sends a second message while the first is still streaming.
**Handling**: Frontend disables the send button during streaming. If a race condition occurs at the API level, the backend queues the second request and processes it after the first stream completes.

### EC-5: Very Long Question
**Scenario**: Investor submits a question exceeding 2,000 characters.
**Handling**: Frontend enforces character limit with a counter. Backend validates and returns `QA_MESSAGE_TOO_LONG` (400) if exceeded.

### EC-6: Low Relevance Results
**Scenario**: pgvector search returns chunks with similarity scores below 0.7 threshold.
**Handling**: If no chunks meet the threshold, the system still proceeds but includes only profile metadata and financial highlights as context. The AI is more likely to respond with "I don't have enough information to answer this question."

### EC-7: Conversation Token Budget Exceeded Mid-Stream
**Scenario**: The AI response pushes total tokens past the 10,000 conversation budget.
**Handling**: The current response is allowed to complete (no mid-stream cutoff). After completion, the conversation is marked as budget-exceeded and further messages are blocked with `QA_CONTEXT_TOO_LARGE`.

### EC-8: Email-Gated Viewer Session Expiry
**Scenario**: An email-gated viewer's session expires during a conversation.
**Handling**: The SSE stream fails. Frontend shows the email gate again. After re-entering email, the viewer can access their existing conversations (matched by viewerEmail).

---

## Dependencies

### Internal Dependencies

- **[ai-document-intelligence.md](./ai-document-intelligence.md)**: Provides `DocumentChunk` records with embeddings in pgvector. Q&A cannot function without processed documents.
- **[company-profile.md](./company-profile.md)**: `QAConversation.profileId` references `CompanyProfile`. Profile metadata is used as context.
- **[company-dataroom.md](./company-dataroom.md)**: Source citations link to dataroom documents for investor access.
- **[open-finance.md](./open-finance.md)**: Financial highlights from `FinancialSnapshot` records are used as supplementary context (optional).
- **[notifications.md](./notifications.md)**: `QA_QUESTION_RECEIVED` notification event type.
- **[user-permissions.md](./user-permissions.md)**: ADMIN role check for founder conversation viewer. `InvestorAccess` model for access control.
- **[audit-logging.md](../.claude/rules/audit-logging.md)**: Q&A events are audit-logged.
- **[api-standards.md](../.claude/rules/api-standards.md)**: Response envelope format, pagination, error codes.
- **[security.md](../.claude/rules/security.md)**: PII masking for investor emails in founder view.

### External Dependencies

- **Anthropic Claude API**: LLM for answer generation. Uses the same SDK as document intelligence.
  - Model: Claude Sonnet (or configured model) for cost-effective Q&A responses
  - Streaming: Native SSE streaming via Anthropic SDK
  - Timeout: 60 seconds per request
  - Retry: 2 attempts with exponential backoff for 5xx errors; no retry for 4xx
- **pgvector (PostgreSQL extension)**: Vector similarity search for RAG retrieval.
  - Cosine similarity operator: `<=>` (lower is more similar)
  - Index: IVFFlat or HNSW on embedding column
- **Bull (Redis-backed)**: Background job for notification sending and audit logging after Q&A events.
  - Queue: `qa-notifications` — debounced notification delivery
- **AWS S3**: Source document links reference S3 pre-signed URLs via the dataroom service.

---

## Technical Implementation

### QAService

```typescript
// /backend/src/qa/qa.service.ts
import { Injectable } from '@nestjs/common';
import { PrismaService } from '../prisma/prisma.service';
import { RagService } from '../ai/rag.service';
import { EmbeddingService } from '../ai/embedding.service';
import { ClaudeService } from '../ai/claude.service';
import { InjectQueue } from '@nestjs/bull';
import { Queue } from 'bull';
import { BusinessRuleException, NotFoundException } from '../common/exceptions';

@Injectable()
export class QAService {
  constructor(
    private prisma: PrismaService,
    private ragService: RagService,
    private embeddingService: EmbeddingService,
    private claudeService: ClaudeService,
    @InjectQueue('qa-notifications') private notificationQueue: Queue,
    @InjectQueue('audit-log') private auditQueue: Queue,
  ) {}

  async createConversation(
    profileId: string,
    userId: string | null,
    viewerEmail: string | null,
    message: string,
  ) {
    // Validate access
    await this.validateAccess(profileId, userId, viewerEmail);

    // Check concurrent conversation limit
    const activeConversations = await this.prisma.qAConversation.count({
      where: {
        profileId,
        ...(userId ? { userId } : { viewerEmail }),
        messageCount: { lt: 50 },
      },
    });
    if (activeConversations >= 5) {
      throw new BusinessRuleException(
        'QA_CONCURRENT_LIMIT',
        'errors.qa.concurrentLimit',
      );
    }

    // Check that company has processed documents
    const profile = await this.prisma.companyProfile.findUniqueOrThrow({
      where: { id: profileId },
      select: { companyId: true, company: { select: { name: true } } },
    });

    const documentCount = await this.prisma.documentChunk.count({
      where: { document: { companyId: profile.companyId } },
    });
    if (documentCount === 0) {
      throw new BusinessRuleException(
        'QA_NO_DOCUMENTS',
        'errors.qa.noDocuments',
      );
    }

    // Create conversation + first user message
    const title = message.length > 80
      ? message.substring(0, message.lastIndexOf(' ', 80)) || message.substring(0, 80)
      : message;

    const conversation = await this.prisma.qAConversation.create({
      data: {
        profileId,
        userId,
        viewerEmail,
        title,
        messageCount: 1,
      },
    });

    const userMessage = await this.prisma.qAMessage.create({
      data: {
        conversationId: conversation.id,
        role: 'USER',
        content: message,
        tokensUsed: 0,
        sourceChunkIds: [],
      },
    });

    return { conversation, userMessage };
  }

  async *streamAnswer(
    conversationId: string,
    companyId: string,
    companyName: string,
    message: string,
  ): AsyncGenerator<{ event: string; data: any }> {
    // 1. Embed the question
    const queryEmbedding = await this.embeddingService.embed(message);

    // 2. Retrieve relevant chunks via pgvector
    const chunks = await this.ragService.retrieveChunks(
      companyId,
      queryEmbedding,
      { topK: 10, threshold: 0.7 },
    );

    // 3. Assemble context
    const context = await this.ragService.assembleContext(
      companyId,
      chunks,
      conversationId,
    );

    // 4. Build system prompt
    const systemPrompt = this.buildSystemPrompt(companyName, context);

    // 5. Get conversation history for continuity
    const history = await this.getConversationHistory(conversationId);

    // 6. Stream Claude response
    let fullContent = '';
    let tokensUsed = 0;

    const stream = this.claudeService.streamMessage(
      systemPrompt,
      [...history, { role: 'user', content: message }],
    );

    for await (const event of stream) {
      if (event.type === 'content_block_delta') {
        const token = event.delta.text;
        fullContent += token;
        yield { event: 'token', data: { token } };
      }
      if (event.type === 'message_delta') {
        tokensUsed = event.usage?.output_tokens || 0;
      }
    }

    // 7. Emit source citations
    const sourceChunkIds = chunks.map((c) => c.id);
    for (const chunk of chunks) {
      yield {
        event: 'source',
        data: {
          chunkId: chunk.id,
          documentId: chunk.documentId,
          documentName: chunk.documentName,
          excerpt: chunk.content.substring(0, 200),
        },
      };
    }

    // 8. Store assistant message
    const assistantMessage = await this.prisma.qAMessage.create({
      data: {
        conversationId,
        role: 'ASSISTANT',
        content: fullContent,
        tokensUsed,
        sourceChunkIds,
      },
    });

    // 9. Update conversation counters
    await this.prisma.qAConversation.update({
      where: { id: conversationId },
      data: {
        messageCount: { increment: 1 }, // +1 for assistant message (user was already counted)
        totalTokensUsed: { increment: tokensUsed },
      },
    });

    // 10. Emit done event
    yield {
      event: 'done',
      data: {
        messageId: assistantMessage.id,
        tokensUsed,
      },
    };

    // 11. Queue notification + audit log (non-blocking)
    await this.notificationQueue.add('qa-question', {
      conversationId,
      companyId,
    });

    await this.auditQueue.add('persist', {
      actorType: 'SYSTEM',
      action: 'QA_ANSWER_GENERATED',
      resourceType: 'QAMessage',
      resourceId: assistantMessage.id,
      companyId,
      metadata: {
        conversationId,
        tokensUsed,
        sourceChunkCount: sourceChunkIds.length,
        source: 'system',
      },
    });
  }

  private buildSystemPrompt(companyName: string, context: string): string {
    return `You are an AI assistant for ${companyName}. Your role is to help investors understand the company by answering their questions accurately and concisely.

Rules:
1. Answer questions based ONLY on the provided context. Do not use any outside knowledge.
2. If the information needed to answer the question is not in the context, say so clearly. Do not guess or make up information.
3. Always cite your sources using the format [Source: document name]. Include the source at the end of the relevant sentence or paragraph.
4. If multiple sources support an answer, cite all of them.
5. Use Brazilian number formatting (1.234,56) for all numbers and currency values.
6. Respond in the same language as the question.
7. Be concise but thorough. Prefer bullet points for lists.
8. For financial data, always specify the time period (e.g., "Q3 2025", "January 2026").

Context:
${context}`;
  }

  private async getConversationHistory(
    conversationId: string,
  ): Promise<Array<{ role: string; content: string }>> {
    const messages = await this.prisma.qAMessage.findMany({
      where: { conversationId },
      orderBy: { createdAt: 'asc' },
      take: 10,
      select: { role: true, content: true },
    });

    return messages.map((m) => ({
      role: m.role === 'USER' ? 'user' : 'assistant',
      content: m.content,
    }));
  }

  private async validateAccess(
    profileId: string,
    userId: string | null,
    viewerEmail: string | null,
  ): Promise<void> {
    // Implementation validates InvestorAccess level or email-gated access
    // See access control business rules
  }

  async checkDailyRateLimit(
    profileId: string,
    userId: string | null,
    viewerEmail: string | null,
  ): Promise<boolean> {
    const startOfDay = new Date();
    startOfDay.setUTCHours(0, 0, 0, 0);

    const todayMessageCount = await this.prisma.qAMessage.count({
      where: {
        role: 'USER',
        createdAt: { gte: startOfDay },
        conversation: {
          profileId,
          ...(userId ? { userId } : { viewerEmail }),
        },
      },
    });

    return todayMessageCount < 20;
  }
}
```

### QA Controller (SSE Streaming)

```typescript
// /backend/src/qa/qa.controller.ts
import {
  Controller, Get, Post, Delete, Body, Param, Query, Res,
  HttpCode, HttpStatus, Sse,
} from '@nestjs/common';
import { Response } from 'express';
import { RequireAuth } from '../auth/decorators/require-auth.decorator';
import { Roles } from '../auth/decorators/roles.decorator';
import { Auditable } from '../audit/auditable.decorator';
import { PaginationQueryDto } from '../common/dto/pagination-query.dto';
import { paginate } from '../common/helpers/paginate';
import { QAService } from './qa.service';

@Controller('api/v1/companies/:companyId/profile/qa')
export class QAController {
  constructor(private qaService: QAService) {}

  @Post('conversations')
  @RequireAuth()
  @HttpCode(HttpStatus.CREATED)
  @Auditable({
    action: 'QA_CONVERSATION_CREATED',
    resourceType: 'QAConversation',
    captureAfterState: true,
  })
  async createConversation(
    @Param('companyId') companyId: string,
    @Body() dto: CreateQAConversationDto,
    @Res() res: Response,
  ) {
    // Create conversation, then stream the first answer via SSE
    const { conversation, userMessage } = await this.qaService.createConversation(
      /* profileId */, /* userId */, /* viewerEmail */, dto.message,
    );

    // Set SSE headers
    res.setHeader('Content-Type', 'text/event-stream');
    res.setHeader('Cache-Control', 'no-cache');
    res.setHeader('Connection', 'keep-alive');
    res.setHeader('X-Conversation-Id', conversation.id);
    res.status(HttpStatus.CREATED);

    // Stream answer
    const stream = this.qaService.streamAnswer(
      conversation.id,
      companyId,
      /* companyName */,
      dto.message,
    );

    for await (const event of stream) {
      res.write(`event: ${event.event}\ndata: ${JSON.stringify(event.data)}\n\n`);
    }

    res.end();
  }

  @Post('conversations/:conversationId/messages')
  @RequireAuth()
  @Auditable({
    action: 'QA_QUESTION_ASKED',
    resourceType: 'QAMessage',
    captureAfterState: true,
  })
  async sendMessage(
    @Param('companyId') companyId: string,
    @Param('conversationId') conversationId: string,
    @Body() dto: SendQAMessageDto,
    @Res() res: Response,
  ) {
    // Validate ownership, rate limits, message limits, token budget
    // Store user message
    // Set SSE headers and stream answer
    res.setHeader('Content-Type', 'text/event-stream');
    res.setHeader('Cache-Control', 'no-cache');
    res.setHeader('Connection', 'keep-alive');

    const stream = this.qaService.streamAnswer(
      conversationId,
      companyId,
      /* companyName */,
      dto.message,
    );

    for await (const event of stream) {
      res.write(`event: ${event.event}\ndata: ${JSON.stringify(event.data)}\n\n`);
    }

    res.end();
  }

  @Get('conversations/:conversationId')
  @RequireAuth()
  async getConversation(
    @Param('companyId') companyId: string,
    @Param('conversationId') conversationId: string,
  ) {
    return this.qaService.getConversation(conversationId);
  }

  @Get('conversations')
  @RequireAuth()
  @Roles('ADMIN')
  async listConversations(
    @Param('companyId') companyId: string,
    @Query() pagination: PaginationQueryDto,
    @Query('investorId') investorId?: string,
    @Query('investorEmail') investorEmail?: string,
    @Query('dateFrom') dateFrom?: string,
    @Query('dateTo') dateTo?: string,
    @Query('sort') sort?: string,
  ) {
    const { items, total } = await this.qaService.listConversations(companyId, {
      page: pagination.page,
      limit: pagination.limit,
      investorId,
      investorEmail,
      dateFrom,
      dateTo,
      sort,
    });

    return paginate(items, total, pagination.page, pagination.limit);
  }

  @Get('my-conversations')
  @RequireAuth()
  async listMyConversations(
    @Param('companyId') companyId: string,
    @Query() pagination: PaginationQueryDto,
  ) {
    const { items, total } = await this.qaService.listInvestorConversations(
      companyId,
      /* userId or viewerEmail */,
      { page: pagination.page, limit: pagination.limit },
    );

    return paginate(items, total, pagination.page, pagination.limit);
  }

  @Delete('conversations/:conversationId')
  @RequireAuth()
  @Roles('ADMIN')
  @HttpCode(HttpStatus.NO_CONTENT)
  @Auditable({
    action: 'QA_CONVERSATION_DELETED',
    resourceType: 'QAConversation',
    captureBeforeState: true,
  })
  async deleteConversation(
    @Param('companyId') companyId: string,
    @Param('conversationId') conversationId: string,
  ) {
    return this.qaService.deleteConversation(conversationId);
  }
}
```

### DTOs

```typescript
// /backend/src/qa/dto/create-qa-conversation.dto.ts
import { IsString, IsNotEmpty, MaxLength } from 'class-validator';

export class CreateQAConversationDto {
  @IsString()
  @IsNotEmpty({ message: 'errors.qa.emptyMessage' })
  @MaxLength(2000, { message: 'errors.qa.messageTooLong' })
  message: string;
}

// /backend/src/qa/dto/send-qa-message.dto.ts
export class SendQAMessageDto {
  @IsString()
  @IsNotEmpty({ message: 'errors.qa.emptyMessage' })
  @MaxLength(2000, { message: 'errors.qa.messageTooLong' })
  message: string;
}
```

---

## Security Considerations

### SEC-1: Company Data Isolation
- RAG queries are always scoped to the company's own DocumentChunks via the `companyId` filter on pgvector search. Cross-company data leakage is prevented at the query level.
- Conversation access is validated against both the profileId and the user/viewer identity.

### SEC-2: PII in Q&A
- Investor emails are masked in the founder conversation viewer (`c***@fund.com`)
- AI system prompt instructs the model not to reveal internal system details or other investors' information
- Conversation content is not indexed or searchable by other investors

### SEC-3: Prompt Injection Prevention
- User messages are placed in the `user` role of the Claude API call, never in the `system` prompt
- The system prompt is fixed and not user-modifiable
- Document chunk content is placed within clearly delimited context blocks
- The AI is instructed to answer only from provided context, reducing the risk of prompt injection leading to information disclosure

### SEC-4: Rate Limiting for Cost Control
- Per-investor daily message limits prevent abuse and control API costs
- Per-conversation token budgets prevent runaway costs on a single conversation
- Concurrent conversation limits prevent resource exhaustion

### SEC-5: Audit Trail
- All Q&A interactions are audit-logged with actor, action, and metadata
- Token usage is tracked for cost monitoring and billing
- Founder access to conversations is itself logged (`AUDIT_LOG_VIEWED`)

---

## Success Criteria

### Performance
- SSE streaming delivers tokens with <200ms latency per token after first token
- First token latency (question received to first token): <3 seconds
- pgvector similarity search: <200ms for companies with up to 10,000 chunks
- Conversation history load: <500ms

### Accuracy
- RAG retrieves relevant context from document embeddings (measured by source citation relevance)
- AI responses correctly cite source documents
- AI correctly refuses to answer when information is not in the context

### User Experience
- Streaming tokens create a smooth typewriter effect
- Source citations are clickable and link to correct documents
- Conversation history is persistent and accessible on return visits
- Rate limit feedback is clear and actionable

### Operational
- Rate limiting prevents abuse (20 messages/day/investor/company)
- Token budget controls costs (10,000 tokens/conversation)
- Founder can view all investor conversations with filtering
- Works for both registered investors and email-gated viewers
- All Q&A events are audit-logged
- Founder receives notifications when investors ask questions

---

## Related Specifications

| Specification | Relationship |
|---------------|-------------|
| [ai-document-intelligence.md](./ai-document-intelligence.md) | Provides DocumentChunk embeddings that power RAG retrieval |
| [company-profile.md](./company-profile.md) | Q&A is accessed through the company profile; profile metadata is used as context |
| [company-dataroom.md](./company-dataroom.md) | Source citations link back to dataroom documents |
| [open-finance.md](./open-finance.md) | Financial highlights supplement RAG context (optional) |
| [notifications.md](./notifications.md) | QA_QUESTION_RECEIVED notification type |
| [user-permissions.md](./user-permissions.md) | ADMIN role for founder viewer; InvestorAccess for Q&A access |
| [audit-logging.md](../.claude/rules/audit-logging.md) | Q&A events are audit-logged |
| [api-standards.md](../.claude/rules/api-standards.md) | Response envelope, pagination, error code format |
| [security.md](../.claude/rules/security.md) | PII masking, data isolation, prompt injection prevention |
| [i18n.md](../.claude/rules/i18n.md) | All user-facing strings in PT-BR and EN |
